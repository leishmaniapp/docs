
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../schema/">
      
      
        <link rel="next" href="../lam/">
      
      
      <link rel="icon" href="../assets/index/leishmaniapp_neumorphic_light.webp">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.34">
    
    
      
        <title>🌎 Cloud - Documentación de Leishmaniapp</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/fonts.css">
    
      <link rel="stylesheet" href="../stylesheets/color.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cloud" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Documentación de Leishmaniapp" class="md-header__button md-logo" aria-label="Documentación de Leishmaniapp" data-md-component="logo">
      
  <img src="../assets/index/leishmaniapp_neumorphic_light.webp" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Documentación de Leishmaniapp
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              🌎 Cloud
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Documentación de Leishmaniapp" class="md-nav__button md-logo" aria-label="Documentación de Leishmaniapp" data-md-component="logo">
      
  <img src="../assets/index/leishmaniapp_neumorphic_light.webp" alt="logo">

    </a>
    Documentación de Leishmaniapp
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🏠 Inicio
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../diseases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🦠 Enfermedades
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🔬 Modelos de Detección
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../schema/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📐 Protobuf Schema
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    🌎 Cloud
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    🌎 Cloud
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vista-general-de-la-arquitectura" class="md-nav__link">
    <span class="md-ellipsis">
      Vista General de la Arquitectura
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#componentes" class="md-nav__link">
    <span class="md-ellipsis">
      Componentes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Componentes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#microservicios" class="md-nav__link">
    <span class="md-ellipsis">
      Microservicios
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Microservicios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service_gateway" class="md-nav__link">
    <span class="md-ellipsis">
      service_gateway
    </span>
  </a>
  
    <nav class="md-nav" aria-label="service_gateway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auth_service" class="md-nav__link">
    <span class="md-ellipsis">
      auth_service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="auth_service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion_1" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#diagnoses_service" class="md-nav__link">
    <span class="md-ellipsis">
      diagnoses_service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="diagnoses_service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion_2" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samples_service" class="md-nav__link">
    <span class="md-ellipsis">
      samples_service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="samples_service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion_3" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analysis_service" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="analysis_service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#headers-http2" class="md-nav__link">
    <span class="md-ellipsis">
      Headers HTTP/2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orden-de-operacion" class="md-nav__link">
    <span class="md-ellipsis">
      Órden de operación
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion_4" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model_wrapper" class="md-nav__link">
    <span class="md-ellipsis">
      model_wrapper
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_wrapper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#funcionamiento" class="md-nav__link">
    <span class="md-ellipsis">
      Funcionamiento
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion_5" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuración">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#esquema-para-el-archivo-de-configuracion-configyaml" class="md-nav__link">
    <span class="md-ellipsis">
      Esquema para el archivo de configuración config.yaml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servicio-de-mensajeria" class="md-nav__link">
    <span class="md-ellipsis">
      Servicio de Mensajería
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Servicio de Mensajería">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#peticiones" class="md-nav__link">
    <span class="md-ellipsis">
      Peticiones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resultados" class="md-nav__link">
    <span class="md-ellipsis">
      Resultados
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#infrastructura-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      Infrastructura (Kubernetes)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Infrastructura (Kubernetes)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instrucciones-de-despliegue" class="md-nav__link">
    <span class="md-ellipsis">
      Instrucciones de Despliegue
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🚀 LAM
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🪲 Depuradores
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vista-general-de-la-arquitectura" class="md-nav__link">
    <span class="md-ellipsis">
      Vista General de la Arquitectura
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#componentes" class="md-nav__link">
    <span class="md-ellipsis">
      Componentes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Componentes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#microservicios" class="md-nav__link">
    <span class="md-ellipsis">
      Microservicios
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Microservicios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service_gateway" class="md-nav__link">
    <span class="md-ellipsis">
      service_gateway
    </span>
  </a>
  
    <nav class="md-nav" aria-label="service_gateway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auth_service" class="md-nav__link">
    <span class="md-ellipsis">
      auth_service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="auth_service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion_1" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#diagnoses_service" class="md-nav__link">
    <span class="md-ellipsis">
      diagnoses_service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="diagnoses_service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion_2" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samples_service" class="md-nav__link">
    <span class="md-ellipsis">
      samples_service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="samples_service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion_3" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analysis_service" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="analysis_service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#headers-http2" class="md-nav__link">
    <span class="md-ellipsis">
      Headers HTTP/2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orden-de-operacion" class="md-nav__link">
    <span class="md-ellipsis">
      Órden de operación
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion_4" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model_wrapper" class="md-nav__link">
    <span class="md-ellipsis">
      model_wrapper
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_wrapper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#funcionamiento" class="md-nav__link">
    <span class="md-ellipsis">
      Funcionamiento
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion_5" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuración">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#esquema-para-el-archivo-de-configuracion-configyaml" class="md-nav__link">
    <span class="md-ellipsis">
      Esquema para el archivo de configuración config.yaml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servicio-de-mensajeria" class="md-nav__link">
    <span class="md-ellipsis">
      Servicio de Mensajería
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Servicio de Mensajería">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#peticiones" class="md-nav__link">
    <span class="md-ellipsis">
      Peticiones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resultados" class="md-nav__link">
    <span class="md-ellipsis">
      Resultados
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#infrastructura-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      Infrastructura (Kubernetes)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Infrastructura (Kubernetes)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instrucciones-de-despliegue" class="md-nav__link">
    <span class="md-ellipsis">
      Instrucciones de Despliegue
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="cloud">🌎 Cloud</h1>
<p>Leishmaniapp es una arquitectura de almacenamiento de información diagnóstica y procesamiento de imágenes, <em>LeishmaniappCloudServicesV2</em> es el nombre asignado al conjunto de servicios en nube capaces de proveer esta funcionalidad</p>
<h2 id="vista-general-de-la-arquitectura">Vista General de la Arquitectura</h2>
<p><em>LeishmaniappCloudServicesV2</em> es una arquitectura basada en <a href="https://aws.amazon.com/es/microservices/">microservicios</a>, cada uno de estos servicios se encarga de una funcionalidad específica, opera de manera independiente y se comunica con los demás elementos de la arquitectura a través de una API <a href="https://grpc.io/">gRPC</a> y un esquema de datos predefinido. (Visite <a href="../schema/"><em>Protobuf Schema</em></a> para más información acerca de la API.)</p>
<p><a class="glightbox" href="../assets/cloud/cloud.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Diagrama de infrastructura de nube" src="../assets/cloud/cloud.png" /></a></p>
<h2 id="componentes">Componentes</h2>
<p>La arquitectura <em>LeishmaniappCloudServicesV2</em> atiende a un cliente (usualmente, pero no limitado a, <a href="../application/"><em>aplicación de Leishmaniapp</em></a>) a través de la API de gRPC utilizando el protocolo HTTP/2 (sin encriptación). Las peticiones deberán ser atendidas por un <a href="#service_gateway">Gateway</a> a través de un único puerto TCP y redirigidas al microservicio capaz de atender la solicitud, el gateway también provee un servicio de <em>health check</em> con el cual los clientes pueden validar la conexión con el servidor.</p>
<p>Cada uno de los microservicios atiende un único servicio definido en <a href="../schema/">protobuf_schema.</a>, estos son: <a href="#auth_service">Autenticación</a>, <a href="#diagnoses_service">Almacenamiento de Diagnósticos</a>, <a href="#samples_service">Almacenamiento de muestras</a> y <a href="#analysis_service">Análisis</a>. Este último mantiene un stream de datos, a través de una conexión bidireccional full-duplex entre el cliente y el servidor, con la cual múltiples peticiones de análisis pueden ser enviadas y sus resultados entregados de manera asíncrona, esto difiere con los demás servicios que son de tipo <em>unicast</em>.</p>
<p>Las peticiones de análisis son enviadas a un <a href="#servicio-de-mensajeria">servicio de mensajería</a> que entregará la petición a un servicio de análisis específico para cada enfermedad a diagnosticar, estos servicios pueden ser implementados en cualquier lenguaje de programación y se incorporan en la arquitectura a través de un <a href="#model_wrapper">servicio de encapsulamiento</a>, para ello los binarios encargados del análisis deben estar en conformidad con el formato <a href="../models/#alef-adapter-layer-exec-format">ALEF</a> (Visite <a href="../models/"><em>Modelos de Detección</em></a> para más información). Los resultados de análisis son enviados al servicio de mensajería quien entregará los resultados al servicio de análisis, se guardará la información de la muestra a través del servicio de almacenamiento de muestras y se enviarán los resultados al cliente de manera asíncrona.</p>
<h3 id="microservicios">Microservicios</h3>
<blockquote>
<p>💡 Los repositorios de cada uno de los servicios hacen uso de  <em>submódulos de git</em>, no olvide inicializarlos con <code>git submodule update --init --recursive</code> después de clonar el repositorio.</p>
<p>💡 Para la creación de las imagenes de contenedores utilize el comando <code>docker build -t &lt;nombre&gt; -f deployment/Containerfile .</code>, donde <code>&lt;nombre&gt;</code> es reemplazado por el nombre que se le asignará a la imagen.</p>
</blockquote>
<p>Cada uno de los microservicios anteriormente mencionados son descritos a detalle en esta sección.</p>
<h4 id="service_gateway">service_gateway</h4>
<blockquote>
<p>📚 Link del repositorio: <a href="https://github.com/leishmaniapp/service_gateway">https://github.com/leishmaniapp/service_gateway</a>.</p>
<p>🐋 Utilice <em>leishmaniapp.cloud/service_gateway</em> como nombre de la imagen de contenedores</p>
</blockquote>
<p>Es un <em>gateway</em> para gRPC personalizado con el cual un cliente puede acceder a todos los servicios ofrecidos por <em>LeishmaniappCloudServicesV2</em> a través de un único punto de acceso.</p>
<p>Este servicio tiene como responsabilidad redirigir las peticiones del cliente al <em>host</em> correspondiente capaz de suplir el requerimiento, la lista de servicios ofrecidos y la información del <em>host</em> asociado se debe de especificar en la sección de <strong>'resources'</strong> en el archivo de configuración <strong>config.yaml</strong>.</p>
<p>Estos servicios también pueden ser protegidos de accesos no autorizados mediante el atributo booleano <strong>'protected'</strong> asociado a cada uno de los items de <strong>'resources'</strong> en el archivo de configuración, el <em>gateway</em> verifica la autenticidad del <em>token</em> de acceso del usuario haciendo uso del servicio <em>leishmaniapp.cloud.auth.AuthService</em> cuyo <em>host</em> debe de ser especificado en la sección <strong>'authentication'</strong> del archivo de configuración.</p>
<h5 id="configuracion">Configuración</h5>
<p>A continuación un ejemplo del archivo de configuración <strong>config.yaml</strong>, este archivo es utilizado en la <a href="#infrastructura-kubernetes">infrastructura con Kubernetes</a></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Server configuration</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span><span class="c1"># Service port</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9871</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1"># Authentication service</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nt">authentication</span><span class="p">:</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">  </span><span class="nt">timeout_sec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grpc-auth.leishmaniapp.svc.cluster.local</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9875</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="c1"># List of services provided by the service</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">leishmaniapp.cloud.auth.AuthService</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grpc-auth.leishmaniapp.svc.cluster.local</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9875</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="c1"># Does not require the user to be authenticated</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">    </span><span class="nt">protected</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">leishmaniapp.cloud.diagnoses.DiagnosesService</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grpc-diagnoses.leishmaniapp.svc.cluster.local</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9873</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">    </span><span class="c1"># User must provide auth token</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">    </span><span class="nt">protected</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">leishmaniapp.cloud.analysis.AnalysisService</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grpc-analysis.leishmaniapp.svc.cluster.local</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9872</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">    </span><span class="nt">protected</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<h4 id="auth_service">auth_service</h4>
<blockquote>
<p>📚 Link del repositorio: <a href="https://github.com/leishmaniapp/auth_service">https://github.com/leishmaniapp/auth_service</a>.</p>
<p>🐋 Utilice <em>leishmaniapp.cloud/auth_service</em> como nombre de la imagen de contenedores</p>
</blockquote>
<p>Este servicio valida la identidad de un cliente (especialista) a través de un <em>token de autenticación</em> <a href="https://jwt.io/">JWT</a>, la lista de especialistas registrados se obtiene de una base de datos (requiere una conexión a <a href="https://www.mongodb.com/">mongodb</a>) y no existe un servicio para la creación de usuarios.</p>
<p>El servicio tiene las siguiente propiedades</p>
<ul>
<li>El identificador del usuario es su <em>email</em></li>
<li>La contraseña es encriptada con el algoritmo <em>bcrypt</em></li>
<li>Solo un <em>token</em> de autenticación es válido en dado momento, este token puede ser invalidado y reemplazado por uno nuevo</li>
<li>Para validar la autenticación se debe validar el <em>token</em> y verificar que coincida con el que se encuentra registrado en la base de datos</li>
</ul>
<p>Ejemplo de un registro en la base de datos:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;leishmaniapp@javeriana.edu.co&quot;</span><span class="p">,</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Default User&quot;</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="nt">&quot;passwordHash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$2a$12$p21C4UmRQEZqX/KBHISuk.dmvIsiiywYl9Cj49BXZFgtL/81H9KyW&quot;</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">  </span><span class="nt">&quot;diseases&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;mock.spots&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;malaria.romanowsky&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;leishmaniasis.giemsa&quot;</span><span class="p">],</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="nt">&quot;token&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="configuracion_1">Configuración</h5>
<p>Para configurar la base de datos y demás propiedades del servicio, se debe de proveer el siguiente archivo <strong>.env</strong>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Run in debug mode (optional, default=false)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nv">DEBUG</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1"># Where the gRPC service will be accesible from (optional, default=9875)</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="nv">SERVER_PORT</span><span class="o">=</span><span class="m">9875</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1"># Database connection string</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1"># Remove double quotes for container .env</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s2">&quot;mongodb+srv://[username:password@]host[/[defaultauthdb][?options]]&quot;</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="c1"># Database operations timeout</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="nv">DATABASE_TIMEOUT</span><span class="o">=</span><span class="m">10</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="c1"># Database source name</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="nv">DATABASE_NAME</span><span class="o">=</span>authDB
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="c1"># Database table or collection</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="nv">DATABASE_TABLE</span><span class="o">=</span>users
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="c1"># Web security HMAC secret</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="c1"># Remove double quotes for container .env</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="nv">SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;your-secret-key&quot;</span>
</span></code></pre></div></p>
<h4 id="diagnoses_service">diagnoses_service</h4>
<blockquote>
<p>📚 Link del repositorio: <a href="https://github.com/leishmaniapp/diagnoses_service">https://github.com/leishmaniapp/diagnoses_service</a>.</p>
<p>🐋 Utilice <em>leishmaniapp.cloud/diagnoses_service</em> como nombre de la imagen de contenedores</p>
</blockquote>
<p>Este servicio almacena los diagnósticos finalizados por el especialista, estos diagnósticos incluyen la información del paciente y la cantidad de elementos de interés encontrados así como cualquier otra observación relevante para la historia clínica del paciente.</p>
<h5 id="configuracion_2">Configuración</h5>
<p>La información debe de ser consolidada en una base de datos <em>mongodb</em> y los parámetros de conexión deben de ser declarados a través de variables de entorno o un archivo <em>.env</em>.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Run in debug mode (Optional, Default=0)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nv">DEBUG</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># Where the gRPC service will be accesible from (Optional, Default=9873)</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nv">SERVER_PORT</span><span class="o">=</span><span class="m">9873</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="c1"># Database connection string</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="nv">DATABASE_URL</span><span class="o">=</span>mongodb+srv://<span class="o">[</span>username:password@<span class="o">]</span>host<span class="o">[</span>/<span class="o">[</span>defaultauthdb<span class="o">][</span>?options<span class="o">]]</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="c1"># Database source name</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="nv">DATABASE_NAME</span><span class="o">=</span>diagnosesDB
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="c1"># Database table or collection</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="nv">DATABASE_TABLE</span><span class="o">=</span>diagnoses
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="c1"># Database operations timeout</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="nv">DATABASE_TIMEOUT</span><span class="o">=</span><span class="m">10</span>
</span></code></pre></div>
<h4 id="samples_service">samples_service</h4>
<blockquote>
<p>📚 Link del repositorio: <a href="https://github.com/leishmaniapp/samples_service">https://github.com/leishmaniapp/samples_service</a>.</p>
<p>🐋 Utilice <em>leishmaniapp.cloud/samples_service</em> como nombre de la imagen de contenedores</p>
</blockquote>
<p>Este servicio se encarga de almacenar los metadatos correspondientes a las muestras de análisis. Actúa como un repositorio central donde se registran y mantienen los resultados de todas las muestras procesadas, que pueden ser utilizadas para diagnósticos posteriores o entrenamiento de nuevos modelos de diagnóstico.</p>
<h5 id="configuracion_3">Configuración</h5>
<p>Este servicio requiere de una conexión a una base de datos <em>mongodb</em>, así como un directorio en donde almacenar las imágenes diagnósticas. Esta configuración debe de ser declarada a través de variables de entorno o un archivo <em>.env</em></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Run in debug mode (Optional, Default=0)</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nv">DEBUG</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="c1"># Where the gRPC service will be accesible from (Optional, Default=9874)</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="nv">SERVER_PORT</span><span class="o">=</span><span class="m">9874</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1"># Database connection string</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="c1"># Remove double quotes for container .env</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="nv">DATABASE_URL</span><span class="o">=</span>mongodb+srv://<span class="o">[</span>username:password@<span class="o">]</span>host<span class="o">[</span>/<span class="o">[</span>defaultauthdb<span class="o">][</span>?options<span class="o">]]</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="c1"># Database operations timeout</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="nv">DATABASE_TIMEOUT</span><span class="o">=</span><span class="m">10</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="c1"># Database source name</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="nv">DATABASE_NAME</span><span class="o">=</span>samplesDB
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="c1"># Database table or collection</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="nv">DATABASE_TABLE</span><span class="o">=</span>samples
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="c1"># Where to store images</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="c1"># Remove double quotes for container .env</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="nv">STORAGE_PATH</span><span class="o">=</span><span class="s2">&quot;./storage&quot;</span>
</span></code></pre></div>
<h4 id="analysis_service">analysis_service</h4>
<blockquote>
<p>📚 Link del repositorio: <a href="https://github.com/leishmaniapp/analysis_service">https://github.com/leishmaniapp/analysis_service</a>.</p>
<p>🐋 Utilice <em>leishmaniapp.cloud/analysis_service</em> como nombre de la imagen de contenedores</p>
</blockquote>
<p>Este servicio recibe las imágenes y otros datos de muestras y los envía a través de un <a href="#servicio-de-mensajeria">servicio de mensajería</a> al <a href="../models/">modelo de análisis</a> correspondiente, los metadatos y resultados de las imágenes son enviados al <a href="#samples_service">servicio de muestras</a> para su almacenamiento y los resultados de análisis son entregados al cliente de manera asíncrona a través de una conexión bidireccional.</p>
<h5 id="headers-http2">Headers HTTP/2</h5>
<p>Este servicio requiere del <em>pseudo-header HTTP/2</em> <code>:from</code> el cual contiene el <em>email</em> del especialista, esto con el fin de identificar y validar las peticiones sin necesidad de inspeccionar el contenido del mensaje y así poder asociarlos a la cola correspondiente.</p>
<p>El <a href="#service_gateway">gateway</a> es el servicio responsable de validar que el <em>header From</em> coincida con el campo <em>email</em> del token de autenticación del <em>header Authorization</em></p>
<h5 id="orden-de-operacion">Órden de operación</h5>
<p>Una vez el cliente inicia una conexión con el servicio de análisis:</p>
<ol>
<li>Se validará la conexión a través del <em>pseudo-header</em> HTTP/2 <code>:from</code>, el cual debe de contener el <em>email</em> del especialista</li>
<li>Se verificará con el <em>servicio de muestras</em> si hay resultados pendientes de entregar y se los enviará</li>
<li>Se creará una cola de resultados específica para el cliente. (Véase <a href="#resultados">resultados en el servicio de mensajería</a>)</li>
<li>Se suscribirá a la cola específica del cliente y a la cola <em>global</em>.</li>
</ol>
<p>Una vez el cliente envía una solicitud de análisis:</p>
<ol>
<li>Se verifica la petición</li>
<li>Se almacenará mediante el <em>servicio de muestras</em> la imagen y sus metadatos</li>
<li>Se enviará la petición al <em>servicio de mensajería</em> para que sea analizado por algún <em>modelo</em>.</li>
</ol>
<p>Una vez el modelo retorna los resultados de análisis:</p>
<ul>
<li>Si se reciben a través de la cola del cliente y la conexión con el cliente está activa, se marca el análisis como entregado, se envían los resultados a través del canal de comunicación y se actualizan los metadatos a través del <em>servicio de muestras</em>.</li>
<li>Si se reciben a través de la cola del cliente pero la conexión ha sido finalizada, se rechaza la entrega de resultados para que sean entregados a la cola global.</li>
<li>Si se reciben a través de la cola <em>global</em>, se marca el análisis como pendiente de entrega y se actualizan los metadatos a través del <em>servicio de muestras</em>. </li>
</ul>
<p>Una vez el cliente abandona la conexión
* Se elimina la cola del cliente</p>
<h5 id="configuracion_4">Configuración</h5>
<p>Este servicio requiere las credenciales de acceso al <em>broker</em> para el <em>servicio de mensajería</em> y la dirección de <em>host</em> del <em>servicio de muestras</em> para el almacenamiento de metadatos.</p>
<p>Esta configuración debe de ser especificada a través de variables de entorno o un archivo <em>.env</em>, a continuación un ejemplo de configuración mediante un archivo <em>.env</em></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Run in debug mode (Optional, Default=0)</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nv">DEBUG</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1"># Where the gRPC service will be accesible from (Optional, Default=9872)</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="nv">SERVER_PORT</span><span class="o">=</span><span class="m">9872</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="c1"># Amount of maximum buffered requests (Optional, Default=10)</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="nv">BUFFER_SIZE</span><span class="o">=</span><span class="m">10</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="c1"># Client queue TTL (Optional, Default=60)</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="nv">QUEUE_TTL_SEC</span><span class="o">=</span><span class="m">60</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="c1"># Analysis request timeout</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="nv">REQUEST_TIMEOUT_SEC</span><span class="o">=</span><span class="m">1200</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="c1"># Remote service timeout</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="nv">SERVICE_TIMEOUT_SEC</span><span class="o">=</span><span class="m">10</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="c1"># AMQP exchange URL for the analysis requests and results</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="nv">MESSAGE_BROKER</span><span class="o">=</span>amqp://user:pass@localhost:5672/
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="c1"># URL to the samples service RPC service</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="nv">SAMPLES_SERVICE</span><span class="o">=</span>localhost:9874
</span></code></pre></div>
<h4 id="model_wrapper">model_wrapper</h4>
<blockquote>
<p>📚 Link del repositorio: <a href="https://github.com/leishmaniapp/model_wrapper">https://github.com/leishmaniapp/model_wrapper</a>.</p>
<p>🐋 Utilice <em>leishmaniapp.cloud/model_wrapper</em> como nombre de la imagen de contenedores</p>
</blockquote>
<p>Permite la integración entre los <a href="../models/">modelos de análisis</a> y <em>LeishmaniappCloudServicesV2</em> sin que estos tengan que implementar código relacionado a la recepción y entrega de mensajes mediante el <a href="#servicio-de-mensajeria">servicio de mensajería</a>.</p>
<h5 id="funcionamiento">Funcionamiento</h5>
<p>Los modelos de análisis deben de ser ejecutables en conformidad con el formato <a href="../models/#alef-adapter-layer-exec-format">ALEF</a>, la invocación de estos ejecutables se realiza a través de la <em>llamada al sistema <a href="https://en.wikipedia.org/wiki/Exec_(system_call)">exec</a></em> o similiar (<code>std::process::Command::new</code> en Rust). Los resultados de análisis son recolectados de la <em>salida estándar (<strong>stdout</strong>)</em> si el resultado de ejecución es 0, el output del <em>error estándar (<strong>stderr</strong>)</em> es ignorado durante la ejecución</p>
<h5 id="configuracion_5">Configuración</h5>
<p>El archivo de configuración <strong>config.yaml</strong> determinará el <em>id</em> de la enfermedad a diagnosticar, la versión del modelo y el <em>path</em> de los <em>modelos de análisis</em> que serán ejecutados, ya sea en serie o paralelo.</p>
<p>A continuación un archivo de configuración extraído de la enfermedad <a href="https://github.com/leishmaniapp/leishmaniasis-giemsa-disease/tree/main"><em>leishmaniasis.giemesa</em></a>. En esta configuración, dos modelos de análisis (<em>macrophages</em> y <em>parasites</em>) se ejecutan en paralelo con la misma imagen de entrada.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">disease</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">leishmaniasis.giemsa</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.0.0&quot;</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nt">exec</span><span class="p">:</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/usr/local/bin/python&quot;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;./macrophages/src/alef.py&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/usr/local/bin/python&quot;</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;./parasites/src/alef.py&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div>
<p>A continuación un ejemplo genérico explorando todas las capacidades del archivo de configuración</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Which disease is this model going to identify, use the disease ID</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nt">disease</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mock.chain&quot;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c1"># Model version</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0.0&quot;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="c1"># List of executables that need to be run (must comply to the AdapterLayerExecFormat)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="c1"># They can be executed in parallel by defining them as members of the array</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="c1"># The input file for this top-level executables is going to be the unaltered</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="nt">exec</span><span class="p">:</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">  </span><span class="c1"># Absolute path to the executable</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;path/to/binary/model_a&quot;</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">    </span><span class="c1"># The output of this model is going to be included in the response</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="c1"># (Optional), default value is true</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="c1"># Only mock.chain:element.a1 and mock.chain:element.a3 are going to be appended to the response</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="c1"># Use &#39;null&#39; to disable the filter and append all the elements</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="c1"># (Optional), default value is null</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="nt">filter</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;element.a1&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;element.a3&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">    </span><span class="c1"># Arguments to pass to the path (this ones go before --alef-in and --alef-out)</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;--sensitivity=0.8&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-d&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;logs.txt&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">    </span><span class="c1"># Specify a list of models that will run after the parent finished</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">    </span><span class="c1"># The input file for this models will be the output file of the parent and thus the parent must accept --alef-out parameter</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">    </span><span class="c1"># (Optional), default value is null</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="nt">next</span><span class="p">:</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;path/to/binary/model_b&quot;</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="w">        </span><span class="c1"># All the outputs from this model will be appended to the output</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="w">        </span><span class="nt">filter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a><span class="w">        </span><span class="nt">next</span><span class="p">:</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;path/to/binary/model_c&quot;</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a><span class="w">            </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a><span class="w">            </span><span class="nt">filter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a><span class="w">            </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a><span class="w">            </span><span class="nt">next</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"> </span><span class="c1"># No more models are going to be called after this one</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;path/to/binary/model_d&quot;</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a><span class="w">        </span><span class="c1"># Filter is ignored when include is false</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a><span class="w">        </span><span class="nt">filter</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a><span class="w">        </span><span class="nt">next</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a><span class="w">  </span><span class="c1"># This model will be executed at the same time as model_a because they are siblings in the array</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/usr/bin/python3&quot;</span>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;path/to/model_e&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--debug&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a><span class="w">    </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a><span class="w">    </span><span class="nt">filter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a><span class="w">    </span><span class="nt">next</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span></code></pre></div>
<h6 id="esquema-para-el-archivo-de-configuracion-configyaml">Esquema para el archivo de configuración <strong>config.yaml</strong></h6>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nt">disease</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ModelExecutor[]</span>
</span></code></pre></div>
<p>ModelExecutor type</p>
<table>
<thead>
<tr>
<th>field</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>path</td>
<td>string</td>
<td>Absolute path to the executable</td>
</tr>
<tr>
<td>include</td>
<td>bool</td>
<td>Will the results of this model be appended to the respnse?</td>
</tr>
<tr>
<td>filter</td>
<td>string[] <em>or</em> null</td>
<td>Which elements returned by the model will be appended to the response</td>
</tr>
<tr>
<td>args</td>
<td>string[]</td>
<td>Additional arguments to pass to the model</td>
</tr>
<tr>
<td>next</td>
<td><strong>ModelExecutor</strong>[] <em>or</em> null</td>
<td>List with future analysis models to call when the current one finishes, the output of these analysis models will be the output of the current one</td>
</tr>
</tbody>
</table>
<h3 id="servicio-de-mensajeria">Servicio de Mensajería</h3>
<p>El servicio de mensajería hace uso del protocolo <a href="https://www.rabbitmq.com/tutorials/amqp-concepts">AMQP 0-9-1</a> (específicamente <a href="https://www.rabbitmq.com/">RabbitMQ</a> es utilizado como broker) para hacer entrega de las peticiones y resultados de análisis.</p>
<h4 id="peticiones">Peticiones</h4>
<p>Las peticiones de análisis se realizan desde el <a href="#analysis_service">servicio de análisis</a> a través de un <em>exchange</em> nombrado <code>analysis:requests</code> de tipo <strong>topic</strong>, este exchange debe de tener una cola para cada una de las enfermedades soportadas y el nombre de estas colas corresponde al <strong><a href="../diseases/">identificador único</a> de la enfermedad</strong>, por lo general las colas deberían de ser creadas por el modelo al iniciar y eliminadas al finalizar.</p>
<p>Las peticiones de análisis deben llevar como tópico el <em>identificador único</em> de la enfermedad a diagnosticar, y los modelos de análisis capaces de diagnosticar esa enfermedad deben de suscribirse para recibir y procesar solicitudes.</p>
<p><a class="glightbox" href="../assets/cloud/mq_request.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="MQ Request Diagram" src="../assets/cloud/mq_request.png" /></a></p>
<h4 id="resultados">Resultados</h4>
<p>Una vez establecida una conexión entre el cliente y el servicio de análisis, este último debe de crear una cola cuyo nombre corresponde al <strong>email del especialista</strong> en un <em>exchange</em> de nombre <code>analysis:response</code> y de tipo <strong>direct</strong>, esta cola es <em>transiente</em> y <em>efímera</em> por lo cuál sólo tiene un suscriptor y es eliminada una vez este libera la conexión. El servicio de análisis debe de liberar la conexión una vez el cliente es deconectado.</p>
<p>Los resultados de análisis se envían desde alguno de los modelos hacia la cola cuyo nombre es equivalente al <strong>email del especialista</strong>, de esta manera los resultados pueden ser entregados de manera inmediata.</p>
<p>El modelo debe de recibir una confirmación de recepción por parte del servicio de análisis que atiende al cliente destino de los resultados, el servicio de análisis puede marcar la entrega como fallida en caso de que el cliente haya abandonado la conexión. Si el mensaje no pudo ser entregado, el modelo debe de reenviar los resultados a la cola de nombre <code>global</code>, esta cola actúa como una <em>cola de mensajes muertos</em> y entregará los resultados a cualquiera de los servicios de análisis disponibles para su almacenamiento (Todos los servicios de análisis deben de estar suscritos a la cola <code>global</code>).</p>
<p><a class="glightbox" href="../assets/cloud/mq_response.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="MQ Response Diagram" src="../assets/cloud/mq_response.png" /></a></p>
<h2 id="infrastructura-kubernetes">Infrastructura (Kubernetes)</h2>
<p>Esta es la plantilla base para generar una configuración declarativa de <em>Kubernetes</em> para <em>LeishmaniappCloudServicesV2</em>.
<a class="glightbox" href="../assets/cloud/kubernetes.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Diagrama de despliegue en Kubernetes" src="../assets/cloud/kubernetes.png" /></a></p>
<h3 id="instrucciones-de-despliegue">Instrucciones de Despliegue</h3>
<ol>
<li>
<p>Crear los volúmenes requeridos</p>
<ol>
<li><strong>Volumen de la Base de Datos:</strong> Contiene la base de datos <strong>mongodb</strong>, que incluye todas las colecciones de <em>autenticación</em>, <em>muestras</em> y <em>diagnósticos</em>. Este volumen debe ser persistido y protegido, ya que contiene los datos principales de la aplicación.</li>
<li><strong>Volumen del Repositorio de Muestras:</strong> Contiene todos los archivos de imágenes sin procesar de muestras subidas a través de <em>leishmaniapp.cloud.analysis.AnalysisService</em>. Debe ser persistido y tener una gran capacidad de almacenamiento. Este volumen debe tratarse como un <strong>data lake</strong> para el entrenamiento de modelos, pero las copias de seguridad no son tan cruciales.</li>
</ol>
</li>
<li>
<p>Crear los <em>namespaces</em></p>
</li>
</ol>
<p>Todos los componentes están aislados dentro de <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/"><em>namespaces de Kubernetes</em></a>. Los namespaces son los siguientes:
    1. <strong>mongodb:</strong> Contiene el <a href="https://github.com/mongodb/mongodb-kubernetes-operator"><em>MongoDB Community Kubernetes Operator</em></a> y las bases de datos <em>mongodb</em> desplegadas (una primaria y dos secundarias con afinidad de pod) por defecto.
    2. <strong>rabbitmq:</strong> Contiene el <a href="https://github.com/rabbitmq/cluster-operator"><em>RabbitMQ Kubernetes Cluster Operator</em></a> y la cola de mensajes <em>rabbitmq</em> desplegada.
    3. <strong>leishmaniapp:</strong> Contiene todos los servicios de <em>Leishmaniapp</em> (Gateway, AuthService, SamplesService, DiagnosesService y AnalysisService), sus secretos correspondientes, configuraciones y <a href="https://kubernetes.io/es/docs/concepts/services-networking/service/"><em>ClusterIP services</em></a>.
    4. <strong>models:</strong> Contiene todos los servicios de análisis desplegados compatibles con el MQ.</p>
<p>Para crear los <em>namespaces</em> requeridos, use el siguiente comando:
   <div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-R<span class="w"> </span>-f<span class="w"> </span>k8s/00-namespace
</span></code></pre></div></p>
<ol>
<li>Instalar los operadores de Kubernetes <strong>MongoDB y RabbitMQ</strong></li>
</ol>
<p>Estos suelen instalarse usando <a href="https://helm.sh/"><strong>helm</strong></a>. Este repositorio utiliza la configuración declarativa de <strong>helm</strong> a través de <a href="https://github.com/roboll/helmfile"><em>helmfile</em></a>. Instale la utilidad <em>helmfile</em> siguiendo la documentación y luego utilice los siguientes comandos para desplegar los <em>charts</em> de helm requeridos en el clúster de Kubernetes:
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>helmfile<span class="w"> </span>init
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>helmfile<span class="w"> </span>apply
</span></code></pre></div></p>
<ol>
<li>
<p>Desplegar y configurar la base de datos <strong>mongodb</strong></p>
<ol>
<li>Despliegue <em>mongodb</em> en el clúster usando el siguiente comando:
   <div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-R<span class="w"> </span>-f<span class="w"> </span>k8s/10-mongodb
</span></code></pre></div></li>
<li>Use las credenciales proporcionadas en el archivo <code>01-credentials.yaml</code> para acceder a la base de datos a través del servicio <code>mongodb-nodeport</code>. Una vez conectado, cree las bases de datos y colecciones requeridas (authDB/specialists, samplesDB/samples, diagnosesDB/diagnoses) y agregue las restricciones necesarias.</li>
<li>Obtenga la <em>cadena de conexión</em> necesaria para que los microservicios accedan a la base de datos a través de los secretos proporcionados por el operador de <em>mongodb</em>. Liste estos secretos con:
   <div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>mongodb<span class="w"> </span>get<span class="w"> </span>secrets
</span></code></pre></div></li>
<li>Use las credenciales para establecer los secretos requeridos en cada uno de los servicios.\
   Ejemplo: Obtenga las credenciales de <em>AuthService</em> con el siguiente comando:
   <div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>mongodb<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>mongodb-database-admin-authserviceuser<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;.data&quot;</span>
</span></code></pre></div>
   Con las credenciales predeterminadas, la salida del comando debería ser (valores codificados en base64):
<div class="language-json highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="nt">&quot;connectionString.standard&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bW9uZ29kYjovL2F1dGhTZXJ2aWNlVXNlcjphdXRoU2VydmljZVBhc3N3b3JkMUBtb25nb2RiLWRhdGFiYXNlLTAubW9uZ29kYi1kYXRhYmFzZS1zdmMubW9uZ29kYi5zdmMuY2x1c3Rlci5sb2NhbDoyNzAxNyxtb25nb2RiLWRhdGFiYXNlLTEubW9uZ29kYi1kYXRhYmFzZS1zdmMubW9uZ29kYi5zdmMuY2x1c3Rlci5sb2NhbDoyNzAxNy9hZG1pbj9yZXBsaWNhU2V0PW1vbmdvZGItZGF0YWJhc2Umc3NsPWZhbHNl&quot;</span><span class="p">,</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="nt">&quot;connectionString.standardSrv&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bW9uZ29kYitzcnY6Ly9hdXRoU2VydmljZVVzZXI6YXV0aFNlcnZpY2VQYXNzd29yZDFAbW9uZ29kYi1kYXRhYmFzZS1zdmMubW9uZ29kYi5zdmMuY2x1c3Rlci5sb2NhbC9hZG1pbj9yZXBsaWNhU2V0PW1vbmdvZGItZGF0YWJhc2Umc3NsPWZhbHNl&quot;</span><span class="p">,</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;YXV0aFNlcnZpY2VQYXNzd29yZDE=&quot;</span><span class="p">,</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;YXV0aFNlcnZpY2VVc2Vy&quot;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
   Copie el valor de <em>connectionString.standard</em> y péguelo en la clave <em>database-str</em> dentro del archivo <code>30-services/20-auth-service/10_secret.yaml</code>. Lo mismo se requiere para los servicios de <em>Diagnoses</em> y <em>Samples</em>.</li>
</ol>
</li>
<li>
<p>Desplegar y configurar el servicio MQ <strong>rabbitmq</strong></p>
<ol>
<li>Despliegue <em>RabbitMQ</em> en el clúster usando el siguiente comando:
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-R<span class="w"> </span>-f<span class="w"> </span>k8s/20-rabbitmq
</span></code></pre></div></li>
<li>Obtenga las credenciales predeterminadas usando el secreto <code>rabbitmq-cluster-default-user</code>. Se sugiere el siguiente comando (<em>kubectl</em> y <em>jq</em> requeridos):
   <div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>rabbitmq<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>rabbitmq-cluster-default-user<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;.data | with_entries(.value |= @base64d)&quot;</span>
</span></code></pre></div></li>
<li>Use el servicio <code>management</code> NodePort para acceder a la <em>Consola de Gestión de RabbitMQ</em> y crear los usuarios <em>analysis</em> y <em>model</em> con sus contraseñas, y configurar los permisos de lectura+escritura del <em>vhost</em> '/'.</li>
</ol>
</li>
<li>
<p>Desplegar los servicios de Leishmaniapp</p>
<ol>
<li>Configure los <em>secrets</em> y las <em>configuraciones</em> correspondientes de acuerdo con las credenciales configuradas para los servicios de <strong>mongodb</strong> y <strong>rabbitmq</strong>.</li>
<li>Despliegue los servicios usando el siguiente comando:
   <div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-R<span class="w"> </span>-f<span class="w"> </span>k8s/30-services
</span></code></pre></div></li>
</ol>
</li>
<li>
<p>Desplegar los <em>modelos de análisis</em></p>
<ol>
<li>Configure el <em>secret</em> correspondiente según las credenciales configuradas para el servicio <strong>rabbitmq</strong>.</li>
<li>Despliegue los servicios usando el siguiente comando:
   <div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-R<span class="w"> </span>-f<span class="w"> </span>k8s/40-models
</span></code></pre></div></li>
</ol>
</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>